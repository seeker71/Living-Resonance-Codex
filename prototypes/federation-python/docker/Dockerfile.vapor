# â˜ï¸ VAPOR Interaction Pod - Temporary, Contextual
FROM python:3.9-slim

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV VAPOR_POD_ID=vapor-pod-001
ENV VAPOR_POD_STATE=VAPOR
ENV VAPOR_POD_TTL=${VAPOR_POD_TTL:-3600}
ENV VAPOR_POD_CONTEXT=${VAPOR_POD_CONTEXT:-default}

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy interaction components
COPY src/platform/ src/platform/
COPY src/core/ src/core/

# Create temporary interaction directories
RUN mkdir -p /app/temp /app/sessions /app/cache

# Create VAPOR startup script with TTL
RUN echo '#!/bin/bash\n\
echo "â˜ï¸ VAPOR Pod ${VAPOR_POD_ID} starting..."\n\
echo "State: ${VAPOR_POD_STATE}"\n\
echo "Context: ${VAPOR_POD_CONTEXT}"\n\
echo "TTL: ${VAPOR_POD_TTL} seconds"\n\
\n\
# Start TTL countdown\n\
( sleep ${VAPOR_POD_TTL} && echo "â˜ï¸ VAPOR Pod ${VAPOR_POD_ID} TTL expired" && exit 0 ) &\n\
TTL_PID=$!\n\
\n\
# Start interaction service\n\
echo "ðŸŒ Starting VAPOR interaction service..."\n\
python src/platform/vapor_interaction.py\n\
\n\
# Wait for TTL or service termination\n\
wait $TTL_PID\n\
echo "â˜ï¸ VAPOR Pod ${VAPOR_POD_ID} shutting down..."' > /app/start_vapor.sh && chmod +x /app/start_vapor.sh

# Expose ports
EXPOSE 5002 8081

# Health check
HEALTHCHECK --interval=15s --timeout=5s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8081/health || exit 1

# Start VAPOR interaction
CMD ["/app/start_vapor.sh"]
